--- 新しいドキュメント管理ルール ---
**重要:** このファイル（`DEVELOPMENT_PLAN.md`）は、今後、いかなる理由があっても既存の内容を書き換えたり、削除したりすることはせず、常に新しい情報を追記する形でのみ操作されます。これにより、開発計画のすべてのバージョンと変更履歴が完全に保持されます。
---------------------------

### フェーズ2：敵の多様化と相互作用（2025/07/12更新）

**概要:**
現在の「プラス（緑）」「マイナス（青）」の敵に加え、新たに「×（かける）」「÷（わる）」の敵を導入し、敵同士の相互作用やレベルアップシステムによって、より戦略的で奥深いゲームプレイを目指す。

---

#### 敵の配色案

*   **プラス（＋）敵:** **緑色** （生命力・回復のイメージ）
*   **マイナス（ー）敵:** **青色** （クールダウン・減少のイメージ）
*   **×（かける）敵:** **赤色** （危険・増殖・攻撃的なイメージ）
*   **÷（わる）敵:** **紫色** （トリッキー・変化・予測不能なイメージ）

---

#### 新しい敵の種類

1.  **×（かける）敵**
    *   **プレイヤーとの相互作用:** 接触時、プレイヤーのHPを2倍にして消滅。
    *   **弾との相互作用:** 被弾時、弾を消さずに斜め四方向（×印）に拡散させる。自身は消滅しない。
    *   **他の敵との相互作用:**
        *   **vs マイナス敵:** 接触すると自身は消滅し、「マイナス敵」のレベルを+1する。
        *   **vs プラス敵:** 接触すると自身は消滅し、「プラス敵」を1体生成する。
        *   **vs ÷敵:** 接触するとお互いに消滅する。
    *   **行動パターン:** 「÷敵」を追いかける。

2.  **÷（わる）敵**
    *   **プレイヤーとの相互作用:** 接触時、プレイヤーのHPを半分にする。
    *   **弾との相互作用:** 被弾時、弾を「マイナス敵（Lv1）」に変化させ、上下二方向（÷印）に分裂させる。自身は消滅しない。
    *   **他の敵との相互作用:**
        *   **vs マイナス敵:** 接触すると自身は消滅し、「マイナス敵」のレベルを-1する。
        *   **vs プラス敵:** 接触すると「＋敵」は消滅し、自身は全4種類の敵からランダムで1種類の敵に変化する。
    *   **行動パターン:** 「×敵」を追いかける。

---

#### 既存敵のレベルアップシステム

1.  **マイナス（青）敵**
    *   **Lv1 (初期):** 基本状態。
    *   **Lv2:** 移動速度上昇。ダメージ2。
    *   **Lv3:** 移動速度低下、プレイヤーから逃走。一定時間ごとにLv1を生成。ダメージ3。
    *   **Lv4:** 移動速度がLv2より上昇、再度プレイヤーを追跡（「×敵」を優先）。ダメージ4。
    *   **Lv5:** 移動停止。高耐久力（弾を複数回無効化）。高速でLv1を生成。ダメージ10。「×敵」と接触してもレベルアップせず、「×敵」が消えるだけ。

2.  **プラス（緑）敵**
    *   **基本仕様:** 弾に当たっても消えず、Lv1のプラス敵を1体生成する。レベルダウンは「マイナス敵」等との接触によって発生。
    *   **レベル毎の特性（逆転現象中）:**
        *   **Lv2:** 移動速度上昇。回復量2。「マイナス敵（Lv2）」と相殺。
        *   **Lv3:** 移動速度低下、「マイナス敵」から逃走。一定時間ごとにLv1を生成。回復量3。
        *   **Lv4:** 移動速度がLv2より上昇、再度「マイナス敵」を追跡。回復量4。
        *   **Lv5:** 移動停止。高耐久力。高速でLv1を生成。回復量10。

---

#### 特殊イベント案

1.  **マイナス効果選択**
    *   **発生条件:** 1分ごとなど、一定時間経過。
    *   **効果:** 3つの選択肢から、ゲームを不利にする効果（例：「マイナス敵」のレベルアップ、出現率増加など）をプレイヤーが一つ選ぶ。

2.  **逆転現象**
    *   **発生条件（案）:** 3分ごとの時間経過、ステージギミックのアイテム、レアなレベルアップ選択肢、購入可能な永久バフなど。
    *   **効果:** 全ての敵の属性が反転する（プラス↔マイナス, ×↔÷）。

---

### 実装方針と検討事項

*   **段階的な実装:**
    1.  まず「×敵」「÷敵」の基本機能（プレイヤーと弾への反応）を実装。
    2.  次に敵同士の相互作用を実装。
    3.  最後にレベルアップシステムと特殊イベントを実装する。
*   **視覚的な分かりやすさ:**
    *   敵のレベルや状態（逃走中など）が分かるように、オーラ、サイズ、色の濃淡などで表現する。
    *   「逆転現象」中は背景色やBGMを変更し、イベント感を演出する。
*   **ゲームバランス:**
    *   プレイヤーがルールに慣れるまで、最初は「プラス」「マイナス」の敵のみ出現させ、ゲームの進行度に応じて「×」「÷」を解放する。
*   **耐久力のルール（要検討）:**
    *   高レベルの敵の耐久力をHP制にすると計算が複雑になる可能性あり。
    *   **改善案:** 「レベルダウンに必要なダメージ量」を各レベルで設定する方式を検討する（例：Lv5→4に下げるには3ダメージ必要、など）。これにより、プレイヤーが「あと何発でレベルを下げられるか」を直感的に理解しやすくなる。

---

### パフォーマンス最適化方針

**懸念事項:**
敵や弾が大量に出現・分裂する仕様のため、将来的にCPU負荷が増大し、ゲームの動作が遅延・フリーズする可能性がある。

**対策:**
ゲーム開発の進捗に合わせて、以下の最適化手法を計画的に導入し、快適なプレイ環境を維持する。

1.  **オブジェクトプーリング (Object Pooling):**
    *   敵や弾を消滅させずに再利用することで、オブジェクト生成・破棄のコストを削減する。
2.  **効率的な衝突判定（空間分割）:**
    *   画面をグリッドに分割し、近接するオブジェクト間でのみ衝突判定を行うことで、計算量を削減する。
3.  **描画のバッチ処理 (Batching):**
    *   LÖVEの`SpriteBatch`機能を利用し、同じ画像をまとめて描画することで、描画処理を高速化する。
---

### バグ修正と仕様改善（2025/07/13追記）

*   **問題:** 「÷敵」と「＋敵」が接触した際、分裂後の敵が即座に再接触し、無限ループに陥ってゲームがクラッシュする問題が発見された。
*   **対策:**
    *   全ての敵に「生成後の無敵時間（spawn invincibility）」を導入する。
    *   敵が生成されてから一定時間（例: 0.2秒）、他のオブジェクトとの衝突判定を無効化する。
    *   これにより、同一フレーム内での無限ループを防ぎ、安定性を確保する。

---

### 新開発方針（2025/07/13決定）

**背景:**
度重なるクラッシュ問題と、将来的な機能拡張（多様なキャラクター、デバッグ機能など）を見据え、場当たり的な修正ではなく、持続可能な開発を可能にするための大規模なコード改修（リファクタリング）を行うことを決定する。

**最優先事項：オブジェクト指向（OOP）に基づいたコードの再設計**

1.  **段階的リファクタリングの採用:**
    *   一度に全てを書き直すリスクを避け、以下の順で段階的にコードをクラス化していく。
        1.  `enemy.lua` のクラス化 (最も複雑なため、効果が最大)
        2.  `bullet.lua` のクラス化
        3.  `player.lua` のクラス化
        4.  `game_state.lua` のクラス化 (Stateパターンの導入)

2.  **キャラクター設計方針の転換:**
    *   単純なクラスの「継承」ではなく、より柔軟で拡張性の高い**「コンポーネントベース設計」**を採用する。
    *   プレイヤーや敵を「器」とみなし、「移動」「攻撃」「特殊能力」といった機能を「部品（コンポーネント）」として実装し、組み合わせることでキャラクターを定義する。
    *   これにより、「弾を撃たないキャラ」のような特殊なキャラクターも、不自然な実装をせずに実現可能になる。

3.  **テーマの早期決定:**
    *   リファクタリングと並行して、ゲームのコアとなるテーマ（例：「お菓子ファンタジー」）を早期に決定する。
    *   決定したテーマは、クラス名やファイル名、変数名に積極的に反映させ、コード全体の一貫性を保つ。

4.  **開発ツールの導入検討:**
    *   テストプレイの効率を上げるため、ゲーム内にデバッグ用のGUIを導入することを検討する（例: `love-imgui`ライブラリの活用）。
    *   F1キーなどで呼び出せるオーバーレイ形式のデバッグコンソールを目標とする。

---

### アイデアメモ（2025/07/13追記、未確定）

#### ゲームシステム全般
- **経験値の獲得方法:** 「+敵」のレベルを弾で下げた際にも経験値を獲得できるようにする。
- **世界観・テーマ:** 
    - 敵をチェスのコマに擬えるアイデア。
    - プレイヤーのモチーフをどうするか（Vampire Survivors風のキャラクター、シューティング風の飛行船など）。
- **敵のサイズ:** 敵の種類やレベルによってサイズを変えるか検討。
- **操作方法の拡張:** 
    - ゲームコントローラーでの操作に対応。
    - マウスでの操作に対応。
- **ステージ:** 
    - ステージ選択画面を設け、広さの異なるステージを選べるようにする。
- **UI/画面:**
    - タイトル画面の導入。
    - オプション画面（音量調整など）の導入。

#### キャラクター（プレイヤー）のアイデア
- **緑の敵を生むキャラ:** 弾の代わりに「+敵」を生成する特殊なプレイスタイル。
- **誘導弾キャラ:** 敵を自動追尾する強力な弾を持つ、初心者向けの高性能キャラ。
- **自爆範囲攻撃キャラ:** 弾が広範囲に爆発するが、プレイヤーも爆風に巻き込まれるとスタン（行動不能）になるハイリスク・ハイリターンなキャラ。
- **逆転現象キャラ:** 弾を一切撃てない代わりに、任意のタイミングで「逆転現象」を発動できる戦略的なキャラ。

#### ステージギミックのアイデア
- **シンボル岩:**
    - フィールドに破壊不能または破壊可能な「+」「-」「×」「÷」の性質を持つ岩を配置する。
    - **性質のアイデア:** 時間経過で成長（効果範囲や数値が増加）する、特定の条件下で動く、プレイヤーが接触して数値を得る/失う、など様々なバリエーションを検討。
- **パワーアップアイテム:**
    - **スター:** 一定時間、完全無敵になる。
    - **画面クリアボム:** 取得すると画面上の敵を全滅させる。
    - **経験値フィーバー:** 一定時間、経験値の獲得量が倍になる。
    - **スピードアップ:** 一定時間、プレイヤーの移動速度が上昇する。

#### マルチプレイヤー
- **ローカル協力/対戦:** 2人～4人でのプレイモード。
- **オンライン対戦:** ランダムな相手とのネットワーク対戦。

#### 開発・技術的な関心事
- **プロの開発手法:** 変数管理（司令塔）以外に、実際のゲーム開発現場で使われているような、現在導入していない技術や設計パターン（例: オブジェクト指向の徹底、デザインパターン、テスト駆動開発など）について調査・検討する。
